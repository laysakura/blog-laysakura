---
title: 自作CPU & 自作OSをやっていく (1)
id: handcraft-cpu-os-1
tags:
  - 自作CPU & 自作OS
date: 2020-01-31 20:54:08
---

2020年1月から、趣味エンジニアリング活動として自作CPUと自作OSをやっていく。

目指してることとか、作りたい成果物とか、ロードマップとか、進捗とかを記録していく。インプットが増えたり手を動かしていくと色々と軌道修正があるだろうから複数記事になるはず。 [自作CPU & 自作OS](/tags/自作CPU-自作OS/) タグで追えるようにしておく。

<!-- more -->

## 目次
<!-- toc -->

## なぜやるか

- CPUとかOSとかHPCとか好きだから
- 2020年3月からプロセッサとかHPCとかコンパイラバックエンドで食っていきそうだから、地力向上
- 専門分野がニッチになっていくほど同じ分野の人たちと互助的につながっておいたほうが良いので、つながるための媒介として

## ゴール成果物

**[RISC-Vの標準ベンチマークアプリケーション](https://github.com/riscv/riscv-tests/tree/master/benchmarks) を爆速実行できるCPUとOSを作る。**
逆にそれ以外の部分は削ぎ落としていく（例: ファイルシステムとかマルチプロセス管理とか）。

- FPGA上に実装した64ビットRISC-Vプロセッサ
    - 対応するISA: RV64I (基本命令セット), RV64M (乗算・除算), RV64F (単精度浮動小数点演算), RV64D (倍精度浮動小数点演算), RV64A (アトミック命令), RV64V (ベクトル演算)
        - これら全てに対応すると、RV64GV を名乗れる。
    - 特徴:
        - 多段パイプライン
        - スーパースカラ
        - アウトオブオーダー実行
        - ベクトル演算 (**TODO:** ベンチマークがベクトル演算に対応しているか調べる)
- RV64Gで動作するシンプルなOS
    - 対応するABI: lp64d
    - 提供するサービス:
        - ブートローダー（OS立ち上げの前提）
        - ELFローダー (ROMから読む)
        - メモリ管理 (**TODO:** ベンチマークがヒープを使わないなら不要。調べる)
        - スレッドをCPUコアに割り当てるスケジューラ (**TODO:** ベンチマークがマルチスレッドに対応しているか調べる)
        - 文字出力 (実行結果を把握するため)
    - 現代的なOSには備わってるけど今回削ぎ落とすサービス:
        - マルチプロセス管理
        - ファイルシステム
        - マルチユーザ
        - 特権レベル
        - ディスクI/O
        - ネットワークI/O

## 何は自分で作らないか

- ベンチマークアプリケーション
    - https://github.com/riscv/riscv-tests/tree/master/benchmarks を使う。
- RISC-Vエミュレータ
    - OS開発中やベンチマークアプリケーション調査でエミュレータが必要になるが、QEMUを使う。
- コンパイラ・リンカ
    - 普段使いのマシンで https://github.com/riscv/riscv-gnu-toolchain で `gcc -march=rv64gv -march=lp64d` で実行可能なELFを作る。
- チップ
    - 適当なFPGAとか使う。全然詳しくない。同じFPGAにおける最速を目指す。

## 実装に使う道具

- ハードウェア
    - FPGA?
        - **TODO:** どんなのが良いのか全くわからない。調べなきゃ。
- CPUハードウェア構成
    - Chisel
        - **TODO:** 全然詳しくない。ほぼ未知。イケてるVerilogへのトランスパイラだと思ってる。調べなきゃ。
- OS記述
    - Rust
        - なるべく https://github.com/rust-embedded 以下の資産を使って、Rust Embedded に貢献していきたい
            - https://github.com/rust-embedded/r0 , https://github.com/rust-embedded/riscv , https://github.com/rust-embedded/riscv-rt あたりは使い所があるかも。

## ロードマップ

未知の事項が多すぎて時間的見積もりは取れてない。大体の進行順序（順次見直し）程度。
技術的なロードマップのみならず、披露する機会のイベントとかも入れ込む。

| 時期       | やること                                                                                                                                                                                                 | フェーズ                 |
|------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------|
| 2020/02    | RustでのRV64G組み込み開発（w/ QEMU）の開発環境を整える。雛形リポジトリとして公開。                                                                                                                       | OS開発: シングルスレッド |
| 2020/02    | ブートローダーを作り、ROM上にELF形式で置いてある "Hello, World!" と文字出力するだけのOS(人はそれをOSとは呼ばない)を起動する。                                                                            | OS開発: シングルスレッド |
| 2020/02    | ベンチマークプログラムと https://github.com/riscv/riscv-tests を調査し、この記事のTODOを解消。                                                                                                           | OS開発: シングルスレッド |
| 2020/02    | OSにELFローダ機能をつける。アプリケーションのELFも、OSと同様にROM上に置いてあるもの。最初のアプリケーションは、Memory-mapped I/O で "Hello, World!" するだけのもの。                                     | OS開発: シングルスレッド |
| 2020/02    | アプリケーションが文字出力するのを簡便にできるシステムコールを作る。 **TODO: ** ベンチマークプログラムが文字出力のために使うシステムコール(?)を調査。                                                    | OS開発: シングルスレッド |
| 2020/02    | OSが、https://github.com/riscv/riscv-tests のシングルスレッドプログラムを一通り動作できるようになる。CPUは段階的に作るため、 `(-march, -mabi) = (rv64i, lp64), ..., (rv64imfdv, lp64d)` のいずれも試す。 | OS開発: シングルスレッド |
| 2020/02/24 | [第1回 自作CPUもくもく会](https://cpu-dev.connpass.com/event/163019/) 参加。                                                                                                                             | CPU開発: RV32I           |
| 2020/02-03 | 32ビット加算器つくる。シミュレーションもFPGA実機もできるようにしておく。                                                                                                                                 | CPU開発: RV32I           |
| 2020/02-03 | 単一クロック方式で `add rd,rs1,rs2` の実行できるようにする。                                                                                                                                             | CPU開発: RV32I           |
| 2020/02-03 | 単一クロック方式で `addw rd,rs,rs2` の実行できるようにする。                                                                                                                                             | CPU開発: RV64I           |
| 2020/03    | 多段パイプラインで `addw rd,rs,rs2` の実行できるようにする。                                                                                                                                             | CPU開発: RV64I           |
| 2020/03    | 多段パイプラインでRV64Iのを実装。ベンチマークを取る。                                                                                                                                                    | CPU開発: RV64I           |
| -          | TBD                                                                                                                                                                                                      |                          |
